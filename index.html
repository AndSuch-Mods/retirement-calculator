<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Retirement Projection Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem 3rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 1.7rem;
      font-size: 1.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.1rem;
      margin-bottom: 1.8rem;
    }

    .card {
      background: #020617;
      border-radius: 1rem;
      padding: 1rem 1.1rem 1.1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      border: 1px solid #1f2937;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 0.8rem;
      color: #93c5fd;
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #cbd5f5;
    }

    input[type="number"] {
      width: 100%;
      padding: 0.42rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px #60a5fa;
    }

    .input-row {
      margin-bottom: 0.8rem;
    }

    .inputs-inline {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr;
      gap: 0.6rem;
    }

    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    .btn-row {
      text-align: center;
      margin: 1rem 0 1.6rem;
    }

    button {
      padding: 0.6rem 1.6rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: white;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(15, 118, 110, 0.5);
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      filter: brightness(0.98);
    }

    #results {
      background: #020617;
      border-radius: 1rem;
      padding: 1.3rem 1.4rem 1rem;
      border: 1px solid #1f2937;
      margin-bottom: 1.5rem;
    }

    #results h2 {
      margin-top: 0;
      margin-bottom: 0.7rem;
      color: #f97316;
    }

    .results-note {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.9rem;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .result-box {
      background: #030712;
      border-radius: 0.75rem;
      padding: 0.85rem 0.95rem 0.9rem;
      border: 1px solid #111827;
    }

    .result-title {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 0.22rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .result-main {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .result-sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .result-list {
      margin: 0.15rem 0 0;
      padding-left: 1.1rem;
    }

    .result-list li {
      margin-bottom: 0.15rem;
      color: #9ca3af;
      font-size: 0.8rem;
    }

    .warning {
      color: #fecaca;
      font-size: 0.83rem;
      margin-top: 0.4rem;
    }

    .ok {
      color: #bbf7d0;
      font-size: 0.83rem;
      margin-top: 0.4rem;
    }

    #chartCard {
      margin-top: 1.5rem;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      max-width: 100%;
      height: 320px;
      overflow: hidden;
    }

    #projectionChart {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.15rem;
    }

    .toggle-option {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      background: #020617;
      padding: 0.22rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #374151;
    }

    .toggle-option input {
      accent-color: #22c55e;
    }

    .chart-note {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-top: 0.4rem;
    }

    @media (max-width: 600px) {
      .card {
        padding: 0.9rem 0.9rem 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Retirement Projection Calculator</h1>

    <div class="grid">
      <!-- Time & Growth -->
      <div class="card">
        <h2>Time &amp; Growth</h2>
        <div class="input-row">
          <label for="currentAge">Current age (years)</label>
          <input type="number" id="currentAge" value="35" min="0" />
        </div>
        <div class="input-row">
          <label for="yearsToRetire">Years until retirement</label>
          <input type="number" id="yearsToRetire" value="25" min="0" />
        </div>
        <div class="input-row">
          <label for="yearsInRetirement">Years in retirement (income needed)</label>
          <input type="number" id="yearsInRetirement" value="30" min="1" />
        </div>
        <div class="input-row">
          <label for="salaryGrowth">Annual salary growth (%)</label>
          <input type="number" id="salaryGrowth" value="3" step="0.1" />
          <div class="hint">Correctly modeled as compounding: salary × (1 + g)<sup>n</sup></div>
        </div>
        <div class="input-row">
          <label for="inflation">Inflation rate (%)</label>
          <input type="number" id="inflation" value="2.5" step="0.1" />
        </div>
      </div>

      <!-- Income & Contributions -->
      <div class="card">
        <h2>Income &amp; 401(k) Contributions</h2>
        <div class="input-row">
          <label for="currentIncome">Current annual income ($)</label>
          <input type="number" id="currentIncome" value="80000" step="1000" />
        </div>
        <div class="input-row">
          <label for="employeePct">Your 401(k) contribution (% of salary)</label>
          <input type="number" id="employeePct" value="10" step="0.5" />
          <div class="hint">Traditional, Roth, or combined – pre-tax vs. Roth doesn’t change the math here.</div>
        </div>
        <div class="input-row">
          <label>Auto-increase your contribution</label>
          <div class="inputs-inline">
            <div>
              <label for="employeeStep">Increase per year (percentage points)</label>
              <input type="number" id="employeeStep" value="0" step="0.5" />
              <div class="hint">e.g. 1 = +1% of salary each year</div>
            </div>
            <div>
              <label for="employeeMaxPct">Max employee contribution (% of salary)</label>
              <input type="number" id="employeeMaxPct" value="15" step="0.5" />
              <div class="hint">Auto-increase stops once this is reached.</div>
            </div>
          </div>
        </div>
        <div class="input-row">
          <label>Employer match</label>
          <div class="inputs-inline">
            <div>
              <label for="matchRate">Match rate (% of your contribution)</label>
              <input type="number" id="matchRate" value="50" step="1" />
              <div class="hint">e.g. 50 = “50% match”</div>
            </div>
            <div>
              <label for="matchCap">Match cap (% of salary)</label>
              <input type="number" id="matchCap" value="6" step="0.5" />
              <div class="hint">e.g. 6 = “up to 6% of pay”</div>
            </div>
          </div>
        </div>
        <div class="input-row">
          <label for="currentSavings">Current retirement savings ($)</label>
          <input type="number" id="currentSavings" value="50000" step="1000" />
        </div>
      </div>

      <!-- Returns & Spending -->
      <div class="card">
        <h2>Returns &amp; Retirement Spending</h2>
        <div class="input-row">
          <label for="preRetReturn">Annual investment return before retirement (%)</label>
          <input type="number" id="preRetReturn" value="7" step="0.1" />
        </div>
        <div class="input-row">
          <label for="postRetReturn">Annual investment return in retirement (%)</label>
          <input type="number" id="postRetReturn" value="5" step="0.1" />
        </div>
        <div class="input-row">
          <label for="desiredIncomeNow">Desired annual spending in retirement (today's $)</label>
          <input type="number" id="desiredIncomeNow" value="60000" step="1000" />
          <div class="hint">Enter this in today’s dollars. We’ll optionally adjust it for inflation when showing future values.</div>
        </div>
        <div class="input-row">
          <label for="otherIncomeNow">Other retirement income (today's $, Social Security/pension/etc.)</label>
          <input type="number" id="otherIncomeNow" value="20000" step="1000" />
        </div>
        <div class="input-row">
          <label>Display &amp; withdrawal mode</label>
          <div class="toggle-row">
            <label class="toggle-option">
              <input type="radio" name="displayMode" value="today" checked />
              <span>Show results in today’s dollars</span>
            </label>
            <label class="toggle-option">
              <input type="radio" name="displayMode" value="future" />
              <span>Show results in future dollars (inflation-adjusted)</span>
            </label>
          </div>
          <div class="hint">
            Your income goal is always entered in today’s dollars. This toggle controls whether results and chart are shown in today’s
            dollars or in future nominal dollars adjusted for inflation.
          </div>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button type="button" onclick="calculateRetirement()">Calculate</button>
    </div>

    <div id="results" style="display:none;">
      <h2>Results</h2>
      <div class="results-note" id="resultsModeNote"></div>
      <div class="result-grid">
        <div class="result-box">
          <div class="result-title">Contribution Rates</div>
          <div class="result-main" id="resultContributionRate"></div>
          <div class="result-sub" id="resultContributionDetails"></div>
        </div>
        <div class="result-box">
          <div class="result-title">Nest Egg at Retirement</div>
          <div class="result-main" id="resultNestEgg"></div>
          <div class="result-sub" id="resultNestEggBreakdown"></div>
        </div>
        <div class="result-box">
          <div class="result-title">Required Nest Egg</div>
          <div class="result-main" id="resultRequiredNestEgg"></div>
          <div class="result-sub" id="resultRequiredDetails"></div>
        </div>
        <div class="result-box">
          <div class="result-title">Sustainable Income vs Goal</div>
          <div class="result-main" id="resultSustainableIncome"></div>
          <div class="result-sub" id="resultSustainableDetails"></div>
        </div>
      </div>
      <div id="resultStatus"></div>
    </div>

    <div class="card" id="chartCard" style="display:none;">
      <h2>Portfolio Projection by Age</h2>
      <p class="hint">
        Bars show estimated portfolio value each year, from your current age through the end of retirement.
      </p>
      <div class="chart-wrapper">
        <canvas id="projectionChart"></canvas>
      </div>
      <div class="chart-note" id="chartModeNote"></div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let projectionChart = null;

    function getNumber(id, defaultValue = 0) {
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v) ? defaultValue : v;
    }

    function formatCurrency(x) {
      if (!isFinite(x)) return "$0";
      return x.toLocaleString(undefined, {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 0
      });
    }

    function formatPercent(x) {
      if (!isFinite(x)) return "0%";
      return (x * 100).toFixed(1) + "%";
    }

    function getDisplayMode() {
      const radios = document.querySelectorAll('input[name="displayMode"]');
      for (const r of radios) {
        if (r.checked) return r.value;
      }
      return "today";
    }

    // Approximate employee rate that corresponds to a given total rate (you + employer).
    function solveEmployeeRateForTotal(p_total_target, p_cap, m) {
      if (!(p_total_target > 0)) return null;
      let best = null;
      let bestDiff = 1e9;
      for (let pe = 0; pe <= 0.6; pe += 0.0005) { // search 0–60%
        const matchEff = Math.min(pe, p_cap) * m;
        const pt = pe + matchEff;
        const diff = Math.abs(pt - p_total_target);
        if (diff < bestDiff) {
          bestDiff = diff;
          best = pe;
        }
      }
      return best;
    }

    function calculateRetirement() {
      const displayMode = getDisplayMode();

      // ----- Inputs -----
      const age0 = Math.max(getNumber("currentAge", 0), 0);
      const N    = Math.max(getNumber("yearsToRetire", 0), 0);
      const T    = Math.max(getNumber("yearsInRetirement", 30), 1);

      const Y0 = getNumber("currentIncome", 0);
      const g  = getNumber("salaryGrowth", 0) / 100;

      const p_ee = getNumber("employeePct", 0) / 100;
      const employeeStepPts     = getNumber("employeeStep", 0);
      const employeeMaxPctInput = getNumber("employeeMaxPct", 0);
      const p_ee_step = employeeStepPts / 100;
      const p_ee_max  = employeeMaxPctInput / 100;

      const m     = getNumber("matchRate", 0) / 100;
      const p_cap = getNumber("matchCap", 0) / 100;

      const A0 = getNumber("currentSavings", 0);

      const r_s = getNumber("preRetReturn", 0) / 100;
      const r_r = getNumber("postRetReturn", 0) / 100;
      const i   = getNumber("inflation", 0) / 100;

      const I0 = getNumber("desiredIncomeNow", 0);
      const B  = getNumber("otherIncomeNow", 0);

      // Starting-year contribution & match (for display)
      const p_match_eff_start = Math.min(p_ee, p_cap) * m;
      const p_total_start = p_ee + p_match_eff_start;

      // Factor for constant-rate calculations
      let K_const = 0;
      if (N > 0 && Y0 > 0) {
        if (Math.abs(r_s - g) < 1e-8) {
          K_const = Y0 * (1 + g) * N * Math.pow(1 + g, N - 1);
        } else {
          const top = Math.pow(1 + r_s, N) - Math.pow(1 + g, N);
          K_const = Y0 * (1 + g) * (top / (r_s - g));
        }
      }

      // Required nest egg (real terms)
      const W0 = Math.max(I0 - B, 0); // real withdrawal needed per year
      const r_real = (1 + r_r) / (1 + i) - 1;

      let PV_needed_real = 0;
      if (W0 > 0) {
        if (Math.abs(r_real) < 1e-8) {
          PV_needed_real = W0 * T;
        } else {
          PV_needed_real = W0 * (1 - Math.pow(1 + r_real, -T)) / r_real;
        }
      }
      const FV_needed_nominal = PV_needed_real * Math.pow(1 + i, N);

      // Future value of current savings alone
      const FV_current = A0 * Math.pow(1 + r_s, N);

      // Needed total contribution % (constant world)
      let p_total_req = null;
      let p_total_level_req = null;

      if (K_const > 0 && W0 > 0) {
        const FV_total_needed = FV_needed_nominal;
        p_total_req = (FV_total_needed - FV_current) / K_const;
        if (p_total_req < 0) p_total_req = 0;

        if (r_real > 0) {
          const PV_needed_real_level = W0 / r_real;
          const FV_needed_nominal_level = PV_needed_real_level * Math.pow(1 + i, N);
          p_total_level_req = (FV_needed_nominal_level - FV_current) / K_const;
          if (p_total_level_req < 0) p_total_level_req = 0;
        }
      }

      // ----- Accumulation with auto-increase schedule (pre-retirement) -----
      const labels = [];
      const balancesNom = [];
      const yearsFromNow = [];

      let balance_total   = A0;
      let balance_contrib = 0;

      labels.push(age0 > 0 ? age0.toString() : "Now");
      balancesNom.push(balance_total);
      yearsFromNow.push(0);

      for (let year = 1; year <= N; year++) {
        const salary = Y0 * Math.pow(1 + g, year);

        let p_ee_year = p_ee + p_ee_step * (year - 1);
        if (p_ee_max > 0 && p_ee_year > p_ee_max) p_ee_year = p_ee_max;
        if (p_ee_year < 0) p_ee_year = 0;

        const p_match_eff_year = Math.min(p_ee_year, p_cap) * m;
        const p_total_year     = p_ee_year + p_match_eff_year;
        const contribution     = p_total_year * salary;

        balance_total   *= (1 + r_s);
        balance_contrib *= (1 + r_s);

        balance_contrib += contribution;
        balance_total   += contribution;

        const ageLabel = age0 > 0 ? (age0 + year).toString() : ("Y" + year);
        labels.push(ageLabel);
        balancesNom.push(balance_total);
        yearsFromNow.push(year);
      }

      const FV_total   = balance_total;
      const FV_contrib = balance_contrib;

      // Real PV of total portfolio at retirement
      const PV_total_real = FV_total / Math.pow(1 + i, N);
      const PV_current_real = FV_current / Math.pow(1 + i, N);
      const PV_contrib_real = FV_contrib / Math.pow(1 + i, N);

      // Sustainable real income from total nest egg
      let W_sustainable = 0;
      if (PV_total_real > 0) {
        if (Math.abs(r_real) < 1e-8) {
          W_sustainable = PV_total_real / T;
        } else {
          W_sustainable = PV_total_real * r_real / (1 - Math.pow(1 + r_real, -T));
        }
      }

      const goalFirstYearNom = W0 * Math.pow(1 + i, N);
      const sustainableFirstYearNom = W_sustainable * Math.pow(1 + i, N);

      const goalMet = (W0 > 0 && W_sustainable >= W0);

      // Suggestion text
      const threshold = 0.01;
      let suggestionText = "";

      if (W0 > 0 && isFinite(W_sustainable)) {
        if (!goalMet && p_total_req !== null && isFinite(p_total_req) && p_total_req > 0) {
          // Shortfall
          const p_ee_target = solveEmployeeRateForTotal(p_total_req, p_cap, m);
          if (p_ee_target !== null) {
            const p_ee_target_pct = p_ee_target * 100;
            if (p_ee_step > 0 && p_ee_target > p_ee) {
              const yearsToTarget = Math.ceil((p_ee_target - p_ee) / p_ee_step);
              suggestionText =
                "You have a shortfall. In a constant-rate sense, total 401(k) contributions (you + employer) would need to average about " +
                formatPercent(p_total_req) + " of salary. With your match this corresponds to roughly " +
                p_ee_target_pct.toFixed(1) + "% employee contribution. Instead of jumping there immediately, " +
                "you could keep your current starting rate of " + (p_ee * 100).toFixed(1) +
                "% and use your auto-increase of " + employeeStepPts.toFixed(1) +
                " pts/yr until you reach about " + p_ee_target_pct.toFixed(1) +
                "% employee (around " + yearsToTarget + " years).";
            } else {
              suggestionText =
                "You have a shortfall. In a constant-rate sense, total 401(k) contributions (you + employer) would need to average about " +
                formatPercent(p_total_req) + " of salary. With your match this is roughly " +
                p_ee_target_pct.toFixed(1) + "% employee contribution.";
            }
          }
        } else if (goalMet && p_total_level_req !== null && isFinite(p_total_level_req) && p_total_level_req > 0) {
          // Surplus: how much you could cut and still keep the account flat in real terms
          const deltaDownTotal = p_total_start - p_total_level_req;
          if (deltaDownTotal > threshold) {
            const p_ee_level = solveEmployeeRateForTotal(p_total_level_req, p_cap, m);
            let tail = "";
            if (p_ee_level !== null) {
              tail =
                " With your match this is about " + (p_ee_level * 100).toFixed(1) +
                "% employee contribution.";
            }
            suggestionText =
              "Your projected plan more than covers your target income. A constant total contribution rate of about " +
              formatPercent(p_total_level_req) +
              " of salary (you + employer) would be enough to keep the account at least flat in real terms forever, " +
              "assuming withdrawals each year equal your goal adjusted for inflation at about " +
              (i * 100).toFixed(1) +
              "% and never exceed that goal. That means you could lower your current starting total contribution rate of " +
              formatPercent(p_total_start) + " by up to " + (deltaDownTotal * 100).toFixed(1) +
              " percentage points and the portfolio would still tend to grow faster than withdrawals in this model." +
              tail;
          }
        }
      }

      // ----- Populate text UI -----
      document.getElementById("results").style.display = "block";

      const resultsModeNote = document.getElementById("resultsModeNote");
      if (displayMode === "today") {
        resultsModeNote.textContent =
          "All dollar amounts below are shown in today’s dollars (purchasing power adjusted for inflation). Values labeled “adjusted for inflation” are future nominal dollars.";
      } else {
        resultsModeNote.textContent =
          "All main dollar amounts below are shown in future nominal dollars (not adjusted back for inflation). Bullet points note the equivalent values in today’s dollars where helpful.";
      }

      document.getElementById("resultContributionRate").textContent =
        formatPercent(p_total_start) + " of salary (starting year)";

      let contributionDetails =
        '<ul class="result-list">' +
        '<li>You: ' + formatPercent(p_ee) + '</li>' +
        '<li>Employer effective (year 1): ' + formatPercent(p_match_eff_start) + '</li>';

      if (employeeStepPts > 0 && employeeMaxPctInput > 0) {
        contributionDetails +=
          '<li>Auto-increase plan: +' + employeeStepPts.toFixed(1) +
          ' pts/yr, up to ' + employeeMaxPctInput.toFixed(1) + '% employee.</li>';
      }

      contributionDetails += '</ul>';
      document.getElementById("resultContributionDetails").innerHTML = contributionDetails;

      // Nest egg display
      let displayNestEgg, displayFromCurrent, displayFromContrib;
      if (displayMode === "today") {
        displayNestEgg = PV_total_real;
        displayFromCurrent = PV_current_real;
        displayFromContrib = PV_contrib_real;
      } else {
        displayNestEgg = FV_total;
        displayFromCurrent = FV_current;
        displayFromContrib = FV_contrib;
      }

      document.getElementById("resultNestEgg").textContent = formatCurrency(displayNestEgg);

      document.getElementById("resultNestEggBreakdown").innerHTML =
        '<ul class="result-list">' +
        '<li>If you stopped adding to retirement today, your current savings alone would grow to about ' +
        formatCurrency(displayFromCurrent) + ' by retirement.</li>' +
        '<li>Growth coming from future contributions (with your schedule): ' +
        formatCurrency(displayFromContrib) + '.</li>' +
        (displayMode === "future"
          ? '<li>In today’s dollars, that total nest egg is about ' + formatCurrency(PV_total_real) + '.</li>'
          : '<li>At retirement, that corresponds to about ' + formatCurrency(FV_total) +
            ' in future dollars (adjusted for inflation).</li>') +
        '</ul>';

      // Required nest egg display
      let displayRequiredNestEgg;
      if (displayMode === "today") {
        displayRequiredNestEgg = PV_needed_real;
      } else {
        displayRequiredNestEgg = FV_needed_nominal;
      }

      document.getElementById("resultRequiredNestEgg").textContent =
        formatCurrency(displayRequiredNestEgg);

      let requiredDetails =
        '<ul class="result-list">' +
        '<li>Income goal from this account: ' + formatCurrency(W0) +
        ' per year (today's dollars).</li>' +
        '<li>The required nest egg above assumes about ' + (i * 100).toFixed(1) +
        '% inflation and ' + (r_r * 100).toFixed(1) +
        '% annual investment returns during retirement.</li>';

      if (displayMode === "future") {
        requiredDetails +=
          '<li>In today’s dollars, that required nest egg is about ' +
          formatCurrency(PV_needed_real) + '.</li>';
      } else {
        requiredDetails +=
          '<li>At retirement, that corresponds to about ' + formatCurrency(FV_needed_nominal) +
          ' in future dollars (adjusted for inflation).</li>';
      }

      if (p_total_level_req !== null && isFinite(p_total_level_req) && p_total_level_req > 0) {
        requiredDetails +=
          '<li>Constant total contribution rate (you + employer) that would keep this account at least flat forever, ' +
          'assuming withdrawals each year equal your goal adjusted for inflation at about ' +
          (i * 100).toFixed(1) + '% and never exceed your stated goal: ' +
          formatPercent(p_total_level_req) + '.</li>';
      }

      requiredDetails += '</ul>';
      document.getElementById("resultRequiredDetails").innerHTML = requiredDetails;

      // Sustainable income display
      let mainSustainable;
      if (displayMode === "today") {
        mainSustainable = W_sustainable;
      } else {
        mainSustainable = sustainableFirstYearNom;
      }
      document.getElementById("resultSustainableIncome").textContent =
        formatCurrency(mainSustainable) + " / year";

      let diff = W_sustainable - W0;
      let shortLabel;
      if (W0 > 0) {
        if (diff >= 0) {
          shortLabel = "Surplus vs goal (today’s dollars): " + formatCurrency(diff) + " per year.";
        } else {
          shortLabel = "Shortfall vs goal (today’s dollars): " + formatCurrency(-diff) + " per year.";
        }
      } else {
        shortLabel = "No income goal entered yet.";
      }

      let sustainableHtml =
        '<ul class="result-list">' +
        '<li>Goal you entered (today's dollars): ' + formatCurrency(W0) + ' per year.</li>' +
        '<li>First-year goal withdrawal at retirement (adjusted for inflation): ' +
        formatCurrency(goalFirstYearNom) + '.</li>';

      if (displayMode === "future") {
        sustainableHtml +=
          '<li>Sustainable income in today’s dollars: ' + formatCurrency(W_sustainable) + ' per year.</li>';
      } else {
        sustainableHtml +=
          '<li>Sustainable income if viewed in future dollars would start at about ' +
          formatCurrency(sustainableFirstYearNom) + ' per year at retirement (adjusted for inflation).</li>';
      }

      sustainableHtml += '<li>' + shortLabel + '</li>';

      if (suggestionText) {
        sustainableHtml += '<li>' + suggestionText + '</li>';
      }

      sustainableHtml += '</ul>';
      document.getElementById("resultSustainableDetails").innerHTML = sustainableHtml;

      const statusEl = document.getElementById("resultStatus");
      if (W0 > 0 && FV_total >= FV_needed_nominal) {
        statusEl.className = "ok";
        statusEl.textContent =
          "On these assumptions, your projected nest egg meets or exceeds the amount needed to fund your target spending.";
      } else if (W0 > 0) {
        statusEl.className = "warning";
        statusEl.textContent =
          "On these assumptions, your projected nest egg is below the amount needed for your target spending. " +
          "Consider higher contributions, a longer working period, lower spending, or revisiting return/inflation assumptions.";
      } else {
        statusEl.className = "ok";
        statusEl.textContent =
          "Enter a desired retirement income and other income to see sufficiency analysis.";
      }

      // ----- Retirement withdrawals (for chart) -----
      const W_base_nominal = Math.max(I0 - B, 0) * Math.pow(1 + i, N);
      let balanceRet = FV_total;
      let exhausted = false;

      for (let j = 1; j <= T; j++) {
        const ageLabel = age0 > 0 ? (age0 + N + j).toString() : ("Ret " + j);
        const t = N + j;

        const Wj = W_base_nominal * Math.pow(1 + i, j - 1);

        if (!exhausted) {
          const nextBalance = balanceRet * (1 + r_r) - Wj;

          labels.push(ageLabel);
          balancesNom.push(nextBalance);
          yearsFromNow.push(t);

          if (nextBalance >= 0) {
            balanceRet = nextBalance;
          } else {
            exhausted = true;
            break;
          }
        } else {
          break;
        }
      }

      // Convert to real balances for display if needed
      const balancesReal = balancesNom.map((b, idx) => {
        const t = yearsFromNow[idx];
        return b / Math.pow(1 + i, t);
      });

      const displayBalances = (displayMode === "today") ? balancesReal : balancesNom;

      // Chart colors based on growth/shrink and sign
      const backgroundColors = [];
      let minBalance = displayBalances[0];
      for (let idx = 0; idx < displayBalances.length; idx++) {
        const v = displayBalances[idx];
        if (v < minBalance) minBalance = v;

        if (v < 0) {
          backgroundColors.push("rgba(248, 113, 113, 0.9)"); // red
        } else if (idx === 0) {
          backgroundColors.push("rgba(34, 197, 94, 0.9)"); // starting point
        } else {
          const prev = displayBalances[idx - 1];
          if (v >= prev) {
            backgroundColors.push("rgba(34, 197, 94, 0.9)"); // growing
          } else {
            backgroundColors.push("rgba(234, 179, 8, 0.9)"); // shrinking
          }
        }
      }

      const yMin = Math.min(0, minBalance);

      const chartCard = document.getElementById("chartCard");
      chartCard.style.display = "block";

      const ctx = document.getElementById("projectionChart").getContext("2d");

      if (projectionChart) {
        projectionChart.destroy();
      }

      const chartModeNote = document.getElementById("chartModeNote");
      if (displayMode === "today") {
        chartModeNote.textContent = "Chart values are shown in today’s dollars (inflation-adjusted).";
      } else {
        chartModeNote.textContent = "Chart values are shown in future nominal dollars (not adjusted back for inflation).";
      }

      projectionChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: (displayMode === "today" ? "Portfolio balance (today’s $)" : "Portfolio balance (nominal $)"),
            data: displayBalances,
            backgroundColor: backgroundColors,
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                maxRotation: 0,
                minRotation: 0,
                autoSkip: true,
                maxTicksLimit: 15,
                callback: function(value, index) {
                  const lbl = this.getLabelForValue(index);
                  return "Age " + lbl;
                }
              },
              grid: {
                display: false
              }
            },
            y: {
              min: yMin,
              ticks: {
                callback: function(value) {
                  return "$" + value.toLocaleString();
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                title: function(ctx) {
                  const lbl = ctx[0].label;
                  if (!lbl) return "";
                  return "Age " + lbl;
                },
                label: function(context) {
                  const val = context.parsed.y || 0;
                  return " " + formatCurrency(val);
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
